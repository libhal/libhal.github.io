
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../pwm/">
      
      
        <link rel="next" href="../uart/">
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>SPI - libhal</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spi-serial-peripheral-interface" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
You're not viewing the latest version.
<a href="../../..">
  <strong>Click here to go to latest.</strong>
</a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("../.."),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="libhal" class="md-header__button md-logo" aria-label="libhal" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            libhal
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SPI
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/libhal/libhal/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    libhal
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  🏡 Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../getting_started/" class="md-tabs__link">
        
  
  
    
  
  🚀 Getting Started

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../user_guide/setup_vscode/" class="md-tabs__link">
          
  
  
  📖 User Guide

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../embedded_systems/" class="md-tabs__link">
          
  
  
  🏫 Education

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contributor_guide/philosophy/" class="md-tabs__link">
          
  
  
  📚 Contributor Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../project_information/status/" class="md-tabs__link">
          
  
  
  📊 Project Information

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../api/index.html" class="md-tabs__link">
        
  
  
    
  
  🧩 APIs

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="libhal" class="md-nav__button md-logo" aria-label="libhal" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    libhal
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/libhal/libhal/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    libhal
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🏡 Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🚀 Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    📖 User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            📖 User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/setup_vscode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🧑🏿‍💻 Setting up VSCode
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/fundamentals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🧱 Fundamentals of libhal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🔗 Interfaces in libhal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🎯 Debugging Firmware
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/error_handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🪤 Error Handling in libhal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ⚖️ Policies & FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    🏫 Education
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            🏫 Education
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../embedded_systems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What are Embedded Systems?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bitmasking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bit Masking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Microcontroller Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gpio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    General Purpose I/O
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dma/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DMA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../timers_and_counters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Timers & Counters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pwm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PWM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    SPI
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    SPI
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-about-spi" class="md-nav__link">
    <span class="md-ellipsis">
      Learning about SPI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spi-interfaces-and-how-to-use-them" class="md-nav__link">
    <span class="md-ellipsis">
      SPI interfaces and how to use them
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SPI interfaces and how to use them">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#public-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Public APIs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clock-rate-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Rate Settings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spi-device-manager" class="md-nav__link">
    <span class="md-ellipsis">
      SPI Device Manager
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spi-utility-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      SPI Utility Libraries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SPI Utility Libraries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#halwrite" class="md-nav__link">
    <span class="md-ellipsis">
      hal::write()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halread" class="md-nav__link">
    <span class="md-ellipsis">
      hal::read()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#halwrite_then_read" class="md-nav__link">
    <span class="md-ellipsis">
      hal::write_then_read()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-in-device-drivers" class="md-nav__link">
    <span class="md-ellipsis">
      Usage in device drivers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-your-own-spi-driver" class="md-nav__link">
    <span class="md-ellipsis">
      Writing your own SPI driver
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../uart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    UART
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../i2c/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    I2C
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DAC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canbus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CAN BUS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sensors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basics of Sensors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../actuators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basics of Actuators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rtos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RTOS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tbd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TBD
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    📚 Contributor Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            📚 Contributor Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    📜 Design Philosophy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/organization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🗃️ Organization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/style/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🎨 Style Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/interface_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🔗 Interface Design Philosophy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/library_guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🔹 Library Development Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/arm_cortex_m_bringup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🧠 ARM Cortex M Bring Up
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/dma_tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ⏩ DMA Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/upgrade_to_libhal_3_device_library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ⬆️ Upgrade Device Library to 3.x.y
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor_guide/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🏗️ Architectural Design Decisions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    📊 Project Information
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            📊 Project Information
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_information/status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🟢 Library Status 🔴
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_information/about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    🧩 APIs
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="spi-serial-peripheral-interface">SPI: Serial Peripheral Interface</h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This document describes the CAN for libhal 5.0.0 which is not available yet.</p>
</div>
<p>Welcome to the libhal Serial Peripheral Interface (SPI) tutorial. SPI is a
commonly used medium speed communication protocol used for things such as SD
cards, sensors, and displays.</p>
<h2 id="learning-about-spi">Learning about SPI</h2>
<p>Here are some resources for learning SPI:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=0nVNwozXsIc">🎥 Understanding SPI by Rohde Schwarz</a>:<ul>
<li><strong>Runtime:</strong> 12min</li>
<li><strong>Description:</strong> This video goes over much of theory and use cases for SPI. After watching this you should have all of the knowledge necessary to continue this tutorial.</li>
</ul>
</li>
</ul>
<h2 id="spi-interfaces-and-how-to-use-them">SPI interfaces and how to use them</h2>
<p>In libhal there is a single interface for SPI: <code>hal::spi_channel</code>. It provides
a means to communicate over the SPI bus and control the chip select for a
device.</p>
<h3 id="public-apis">Public APIs</h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">spi_channel</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">settings</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">mode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">u8</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">m0</span><span class="p">,</span><span class="w"> </span><span class="c1">// SPI mode 0</span>
<span class="w">      </span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="c1">// SPI mode 1</span>
<span class="w">      </span><span class="n">m2</span><span class="p">,</span><span class="w"> </span><span class="c1">// SPI mode 2</span>
<span class="w">      </span><span class="n">m3</span><span class="p">,</span><span class="w"> </span><span class="c1">// SPI mode 3</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">clock_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="n">_kHz</span><span class="p">;</span>
<span class="w">    </span><span class="n">mode</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mode</span><span class="o">::</span><span class="n">m0</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">settings</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_settings</span><span class="p">);</span>
<span class="w">  </span><span class="n">u32</span><span class="w"> </span><span class="nf">clock_rate</span><span class="p">();</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">transfer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="w"> </span><span class="k">const</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p_data_out</span><span class="p">,</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p_data_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{},</span>
<span class="w">                </span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="w"> </span><span class="n">p_filler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">default_filler</span><span class="p">);</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">chip_select</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">p_select</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">chip_select</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">chip_select</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>"channel" terminology for a spi driver may be a bit foreign to typical
users of SPI. Why a "channel"? Channel implies a dedicated communication
path. It can also imply that there is some sharing between other such
channels utilizing the same bus resource but in a controlled way.</p>
</div>
<p>Use the comments labeled below to explain how you'd use <code>hal::spi_channel</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">spi_channel_usage</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Set the settings for this channel. Note that this does not apply the</span>
<span class="w">  </span><span class="c1">// settings to the SPI bus immediately. Instead it caches the configuration</span>
<span class="w">  </span><span class="c1">// settings and applies them to the SPI bus after bus acquisition via the</span>
<span class="w">  </span><span class="c1">// `chip_select()` or `transfer()` APIs.</span>
<span class="w">  </span><span class="n">spi</span><span class="p">.</span><span class="n">configure</span><span class="p">({</span>
<span class="w">    </span><span class="p">.</span><span class="n">clock_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">250</span><span class="n">_kHz</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">m0</span><span class="p">,</span><span class="w"> </span><span class="c1">// select SPI MODE 0</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Acquires exclusive control over the spi bus and applies configuration</span>
<span class="w">  </span><span class="c1">// settings to the bus. If the bus is currently busy, this call will block</span>
<span class="w">  </span><span class="c1">// until control over the bus is available.</span>
<span class="w">  </span><span class="n">spi</span><span class="p">.</span><span class="n">chip_select</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// After this point, the settings passed into configure will be applied to</span>
<span class="w">  </span><span class="c1">// the SPI bus.</span>

<span class="w">  </span><span class="c1">// Write `device_config_payload` to the device selected on the bus</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">device_config_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4A</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">spi</span><span class="p">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">device_config_payload</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Read 2 bytes from the bus into the response buffer.</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="n">spi</span><span class="p">.</span><span class="n">transfer</span><span class="p">({},</span><span class="w"> </span><span class="n">response</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Releases control over the spi bus</span>
<span class="w">  </span><span class="n">spi</span><span class="p">.</span><span class="n">chip_select</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Now use the data in `response`.</span>
<span class="p">}</span>
</code></pre></div>
<p>The above works but in general, direct control over the chip select should be
avoided and <code>std::lock_guard</code> should be used instead.</p>
<div class="highlight"><pre><span></span><code><span class="kt">float</span><span class="w"> </span><span class="nf">read_sensor_data</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Prefer to use `std::lock_guard` as an automatic way to acquire and release</span>
<span class="w">  </span><span class="c1">// the spi bus at the end of the scope. Also ensures the bus is released in</span>
<span class="w">  </span><span class="c1">// the event of an exception.</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="w"> </span><span class="n">access_bus</span><span class="p">(</span><span class="n">p_spi</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Perform a write transfer then a read</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sensor_register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x03</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">p_spi</span><span class="p">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">sensor_register</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sensor_data</span><span class="p">{};</span>
<span class="w">  </span><span class="c1">// Passing an empty span for the `p_data_out` will cause the SPI bus to</span>
<span class="w">  </span><span class="c1">// transfer the default filler byte 0xFF. Data will be read from the bus into</span>
<span class="w">  </span><span class="c1">// the `sensor_data` array.</span>
<span class="w">  </span><span class="n">p_spi</span><span class="p">.</span><span class="n">transfer</span><span class="p">({},</span><span class="w"> </span><span class="n">sensor_data</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Use the data to compute the sensor reading. Note this is all made up for</span>
<span class="w">  </span><span class="c1">// demonstration purposes.</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sensor_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">sensor_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">12.0f</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// After the return, access_bus is destroyed and the bus is released!</span>
</code></pre></div>
<h3 id="clock-rate-settings">Clock Rate Settings</h3>
<p>Setting the clock rate for SPI is a "best effort" approach following this expression:</p>
<div class="highlight"><pre><span></span><code><span class="n">spi</span><span class="p">.</span><span class="n">clock_rate</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">settings</span><span class="p">.</span><span class="n">clock_rate</span><span class="p">;</span><span class="w"> </span><span class="c1">// this always evaluates to TRUE.</span>
</code></pre></div>
<p>The actual clock rate of the SPI bus will be equal to or less than the
<code>settings.clock_rate</code> passed to the <code>configure</code> API. We make these assumptions
about how SPI will be used:</p>
<ul>
<li>Devices that communicate over SPI have a maximum clock rate they can tolerate.</li>
<li>Devices that communicate over SPI can talk at frequencies below their maximum
  without issue.</li>
<li>Any call to <code>configure</code> could be a request to set the clock rate to the
  maximum a device can support.</li>
</ul>
<p>With these assumptions, a reasonable approach to clock rate setup would be to allow the bus frequency to be equal to or below the selected clock rate. If you have an application where the clock rate has to meet a very tight tolerance, you can use the <code>clock_rate()</code> function to return the integer value of the frequency in hertz.</p>
<p>We choose this over throwing an exception if they do not match, because we believe that most users will be okay with "fastest possible" vs "exactly the number I specified". And if they really need the second one, they can check themselves.</p>
<h2 id="spi-device-manager">SPI Device Manager</h2>
<p>In order to acquire spi_channels you will need an spi device manager. SPI
channels are acquired from a platform's SPI manager object like so:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-arm-mcu/stm32f1/output_pin.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-arm-mcu/stm32f1/spi.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/atomic_spin_lock.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initialize_platform</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// do stuff ...</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">atomic_spin_lock</span><span class="w"> </span><span class="n">spi_bus_lock</span><span class="p">;</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">stm32f1</span><span class="o">::</span><span class="n">output_pin</span><span class="w"> </span><span class="n">cs1</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">stm32f1</span><span class="o">::</span><span class="n">output_pin</span><span class="w"> </span><span class="n">cs2</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Select SPI bus 1, and pass it the</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">stm32f1</span><span class="o">::</span><span class="n">spi</span><span class="w"> </span><span class="n">spi_manager</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">port</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">spi_bus_lock</span><span class="p">);</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">spi_channel1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi_manager</span><span class="p">.</span><span class="n">acquire_channel</span><span class="p">(</span><span class="n">cs1</span><span class="p">);</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">spi_channel2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi_manager</span><span class="p">.</span><span class="n">acquire_channel</span><span class="p">(</span><span class="n">cs2</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// do other stuff ...</span>
<span class="p">}</span>
</code></pre></div>
<p>The code provides a chip select output pin to the spi manager and it returns
a <code>hal::spi_channel</code> with access to the SPI bus. Each spi manager object
controls a single bus so creating a channel results in multiple objects that
have access to a single bus. Because of this, the spi channel objects must
ensure that only one chip select out of the set of spi channel's corresponding
to a single spi bus is active at a time AND that only one channel gets access
to the spi bus at a time.</p>
<h2 id="spi-utility-libraries">SPI Utility Libraries</h2>
<p><code>libhal-util</code> provides a couple of helpful APIs for using SPI.</p>
<p>Each of the APIs below automatically asserts the chip select so it is not
necessary to do so outside. If you need to perform multiple writes, read, or
write-then-read operations without asserting and de-asserting the chip select
each time, add the <code>hal::no_cs</code> token as the first parameter of the utility
APIs.</p>
<h3 id="halwrite"><code>hal::write()</code></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_write_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="mh">0x22</span><span class="p">};</span>
<span class="w">  </span><span class="c1">// Performs chip select, writes `payload` on the spi bus, ignore bytes on the</span>
<span class="w">  </span><span class="c1">// receive line.</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Or you can use <code>std::to_array</code> to create a temporary array inline.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_write_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Performs chip select, writes array { 0x04, 0x22 } on the spi bus, ignore</span>
<span class="w">  </span><span class="c1">// bytes on the receive line.</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">({</span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="mh">0x22</span><span class="p">}));</span>
<span class="p">}</span>
</code></pre></div>
<p>And here is how you use <code>hal::no_cs</code> with the <code>write</code> API.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_write_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">,</span>
<span class="w">                           </span><span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="w"> </span><span class="k">const</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p_ssid</span><span class="p">,</span>
<span class="w">                           </span><span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="w"> </span><span class="k">const</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p_password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">({</span><span class="mh">0xAA</span><span class="p">,</span><span class="w"> </span><span class="mh">0xBB</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7F</span><span class="p">});</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">spacer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="o">&gt;</span><span class="p">({</span><span class="mh">0x00</span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Select the chip via std::lock_guard</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="w"> </span><span class="n">select_device</span><span class="p">(</span><span class="n">p_spi</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Write the following sets of data without asserting and de-asserting for</span>
<span class="w">  </span><span class="c1">// reach write operation.</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">no_cs</span><span class="p">,</span><span class="w"> </span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="p">);</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">no_cs</span><span class="p">,</span><span class="w"> </span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">p_ssid</span><span class="p">);</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">no_cs</span><span class="p">,</span><span class="w"> </span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">spacer</span><span class="p">);</span><span class="w"> </span><span class="c1">// lets assume this is necessary</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">no_cs</span><span class="p">,</span><span class="w"> </span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">p_password</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="halread"><code>hal::read()</code></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_read_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer</span><span class="p">{};</span>

<span class="w">  </span><span class="c1">// Perform an SPI read, ignore bytes on the receive line.</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">read</span><span class="p">(</span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Buffer contains 2 bytes read from the SPI bus</span>
<span class="p">}</span>
</code></pre></div>
<p>If you you want to read a fixed number of bytes, you can set the template
parameter to an unsigned number and that amount of bytes will be read and
returned as an <code>std::array&lt;hal::byte, N&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_read_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Perform an SPI read of 4 bytes and return the array</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">read</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// response contains 4 bytes read from the SPI bus</span>
<span class="p">}</span>
</code></pre></div>
<p>And here is how you use <code>hal::no_cs</code> with the <code>read</code> API.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_read_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Select the chip via std::lock_guard</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="w"> </span><span class="n">select_device</span><span class="p">(</span><span class="n">p_spi</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Read 4 bytes without changing the chip select state.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">read</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">no_cs</span><span class="p">,</span><span class="w"> </span><span class="n">p_spi</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Use `response` ...</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="halwrite_then_read"><code>hal::write_then_read()</code></h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_read_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer</span><span class="p">{};</span>

<span class="w">  </span><span class="c1">// Perform an SPI write operation, ignoring the bytes received during the</span>
<span class="w">  </span><span class="c1">// write operation, then perform a read operation, filling the write bytes</span>
<span class="w">  </span><span class="c1">// with the filler bytes.</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">write_then_read</span><span class="p">(</span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Buffer contains 3 bytes of data read from the SPI bus</span>
<span class="p">}</span>
</code></pre></div>
<p>If you you want to read back a fixed number of bytes, you can set the template
parameter to an unsigned number and that amount of bytes will be read and
returned as an <code>std::array&lt;hal::byte, N&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_write_then_read_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Select the chip via std::lock_guard</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="w"> </span><span class="n">select_device</span><span class="p">(</span><span class="n">p_spi</span><span class="p">);</span>

<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="c1">// Perform an SPI write operation, ignoring the bytes received during the</span>
<span class="w">  </span><span class="c1">// write operation, then perform a read operation, filling the write bytes</span>
<span class="w">  </span><span class="c1">// with the filler bytes.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">write_then_read</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Response contains 3 bytes of data read from the SPI bus</span>
<span class="p">}</span>
</code></pre></div>
<p>And here is how you use <code>hal::no_cs</code> with the <code>hal::write_then_read</code> API.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;libhal-util/spi.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">hal_write_then_read_spi_example</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="c1">// Select the chip via std::lock_guard</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="w"> </span><span class="n">select_device</span><span class="p">(</span><span class="n">p_spi</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Write `data_reg` address then read 4 bytes without changing the chip</span>
<span class="w">  </span><span class="c1">// select state.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">write_then_read</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">no_cs</span><span class="p">,</span><span class="w"> </span><span class="n">p_spi</span><span class="p">,</span><span class="w"> </span><span class="n">data_reg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="usage-in-device-drivers">Usage in device drivers</h2>
<p>A typical device driver class that requires an spi channel would look like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">pseudo_temperature_sensor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">temperature_sensor</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="c1">/// Accept a `hal::spi_channel` by reference, and capture it&#39;s address</span>
<span class="w">  </span><span class="n">pseudo_temperature_sensor</span><span class="p">(</span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_spi</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">m_spi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_spi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">config_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_array</span><span class="p">({</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Set the bus settings</span>
<span class="w">    </span><span class="n">m_spi</span><span class="o">-&gt;</span><span class="n">configure</span><span class="p">(</span><span class="n">settings</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Write configuration register address to bus and then read back an array</span>
<span class="w">    </span><span class="c1">// with length 1, and access byte [0].</span>
<span class="w">    </span><span class="n">hal</span><span class="o">::</span><span class="n">u8</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">write_then_read</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">m_spi</span><span class="p">,</span><span class="w"> </span><span class="n">config_address</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// Set enable bit (5) in config register</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Write back configuration with enable bit set to the configuration</span>
<span class="w">    </span><span class="c1">// register.</span>
<span class="w">    </span><span class="n">hal</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">m_spi</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_array</span><span class="p">({</span><span class="w"> </span><span class="n">config_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="p">}));</span>
<span class="w">  </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">::</span><span class="n">settings</span><span class="w"> </span><span class="n">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">clock_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="n">_MHz</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">m0</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="nf">driver_read</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Made up ration to convert binary i16 value to celsius</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">bin_to_celsius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.025f</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Made up address of the temperature data</span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">temperature_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_array</span><span class="p">({</span><span class="w"> </span><span class="mh">0x02</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// We write the address and read back 2 bytes of data</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hal</span><span class="o">::</span><span class="n">write_then_read</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">m_spi</span><span class="p">,</span><span class="w"> </span><span class="n">temperature_address</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Combine the data bytes into an i16 value.</span>
<span class="w">    </span><span class="n">hal</span><span class="o">::</span><span class="n">i16</span><span class="w"> </span><span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// Calculate the temperature and return it.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">temperature</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bin_to_celsius</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Store hal::spi_channel as a pointer (never a reference)</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">spi_channel</span><span class="o">*</span><span class="w"> </span><span class="n">m_spi</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="writing-your-own-spi-driver">Writing your own SPI driver</h2>
<p>TBD</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../pwm/" class="md-footer__link md-footer__link--prev" aria-label="Previous: PWM">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                PWM
              </div>
            </div>
          </a>
        
        
          
          <a href="../uart/" class="md-footer__link md-footer__link--next" aria-label="Next: UART">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                UART
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "content.tabs.link", "toc.integrate", "navigation.tracking", "navigation.footer"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>