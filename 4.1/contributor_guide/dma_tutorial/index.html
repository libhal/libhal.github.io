
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../arm_cortex_m_bringup/">
      
      
        <link rel="next" href="../upgrade_to_libhal_3_device_library/">
      
      
        
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>‚è© DMA Tutorial - libhal</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dma-direct-memory-access-development-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
You're not viewing the latest version.
<a href="../../..">
  <strong>Click here to go to latest.</strong>
</a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("../.."),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="libhal" class="md-header__button md-logo" aria-label="libhal" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            libhal
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ‚è© DMA Tutorial
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/libhal/libhal/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    libhal
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  üè° Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../getting_started/" class="md-tabs__link">
        
  
  
    
  
  üöÄ Getting Started

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../user_guide/setup_vscode/" class="md-tabs__link">
          
  
  
  üìñ User Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../education/embedded_systems/" class="md-tabs__link">
          
  
  
  üè´ Education

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../philosophy/" class="md-tabs__link">
          
  
  
  üìö Contributor Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../project_information/status/" class="md-tabs__link">
          
  
  
  üìä Project Information

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../api/index.html" class="md-tabs__link">
        
  
  
    
  
  üß© APIs

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="libhal" class="md-nav__button md-logo" aria-label="libhal" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    libhal
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/libhal/libhal/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    libhal
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üè° Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üöÄ Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    üìñ User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    üìñ User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/setup_vscode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üßëüèø‚Äçüíª Setting up VSCode
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/fundamentals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üß± Fundamentals of libhal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üîó Interfaces in libhal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üéØ Debugging Firmware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/error_handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ü™§ Error Handling in libhal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ‚öñÔ∏è Policies & FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    üè´ Education
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    üè´ Education
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/embedded_systems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    What are Embedded Systems?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/bitmasking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bit Masking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Microcontroller Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/gpio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    General Purpose I/O
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/dma/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DMA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/timers_and_counters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Timers & Counters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/adc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/pwm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PWM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/spi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SPI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/uart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UART
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/i2c/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I2C
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/dac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DAC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/canbus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CAN BUS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/sensors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basics of Sensors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/actuators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basics of Actuators
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/rtos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RTOS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/tbd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TBD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    üìö Contributor Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    üìö Contributor Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üìú Design Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../organization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üóÉÔ∏è Organization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../style/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üé® Style Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interface_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üîó Interface Design Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../library_guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üîπ Library Development Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../arm_cortex_m_bringup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üß† ARM Cortex M Bring Up
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    ‚è© DMA Tutorial
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    ‚è© DMA Tutorial
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#channels" class="md-nav__link">
    <span class="md-ellipsis">
      
        Channels
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ram-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ram blocks
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-halplatformsetup_dma_transferdma" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementing hal::&lt;platform&gt;::setup_dma_transfer(dma)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing hal::&lt;platform&gt;::setup_dma_transfer(dma)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-the-dma-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementing the dma structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-setup_dma_transfer-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementing the setup_dma_transfer function
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade_to_libhal_3_device_library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ‚¨ÜÔ∏è Upgrade Device Library to 3.x.y
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üèóÔ∏è Architectural Design Decisions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    üìä Project Information
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    üìä Project Information
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_information/status/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üü¢ Library Status üî¥
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_information/about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üß© APIs
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="dma-direct-memory-access-development-guide">‚è© DMA: Direct Memory Access Development Guide</h1>
<p>DMA is a key feature in many microcontrollers. DMA allows data to be transferred
from one location to another without the need for the CPU to perform the copy.
This can be used to transfer large amounts of data from one place in memory to
another place. It can also be used to automatically transfer data to a
peripheral.</p>
<p>As an example, lets consider an peripheral implementation of <code>hal::spi</code>. In order to write an spi driver without DMA, the CPU has to load a register used by the peripheral with data, then wait for the data to be shifted out of the device, before another byte can be put in. This means that the CPU has to baby sit the spi peripheral for each and every byte that is transferred. Whereas with DMA all that is needed is to tell the controller:</p>
<ol>
<li>The address of source data</li>
<li>The address of the destination data</li>
<li>The length of the transfer</li>
<li>The word width of the source &amp; destination (8-bit, 16-bit, 32-bit)</li>
<li>[optional] The endianness of the transfer</li>
<li>And whether or not to increment the source and/or the destination address</li>
</ol>
<p>After that, just fire it off and it will do the work of loading the data register for you until it finishes. On completion, an interrupt will be invoked that indicates to the application that the transfer has completed.</p>
<p>And that about it for simplicity. There are typically other configurations such as:</p>
<ol>
<li>Stride/stride-length: how many words lengths to skip in the input or output sequence. For example, if you had two dacs and PCM16 with L/R data alternating in the array like so, <code>u16l0, u16r0, u16l1, u16_r1, ..., u16_ln, u16_rn</code>, then the left side dac could start at address 0 with a stride length of 2 to skip the right side data. The same logic can be used to setup the right dac.</li>
<li>Circular mode: DMA channels acts like a ring buffer allowing it to jump back to the start of the buffer when it reaches the end. This is very useful for <code>hal::serial</code> implementations.</li>
<li>Burst size: allows a DMA controller to keep control over the bus for multiple cycles in order to ensure that data is sent without any break time.</li>
</ol>
<h2 id="channels">Channels</h2>
<p>DMA controllers generally have a fixed set of DMA channels. These channels can
operate independently, and allows for multiple transfer to occur at the "same"
time.</p>
<p>Channels can be used for a period of time or can be occupied for the lifetime of a driver. In general, DMA channels shouldn't be help for the lifetime of the
driver as that would limit the number of available DMA channels that can be used by other drivers. An explicit exception to this is <code>hal::serial</code> which requires that its implementation is backed by a buffer. It is common to see
uart implementations where there is only a single byte register for the uart data that is overwritten when the next byte is received. In order to not lose bytes, either an interrupt service routine is needed or DMA can be used fill up a buffer of bytes. Interrupts, although fast, still require cpu attention where as DMA handle this work for the cpu.</p>
<p>The number of channels is limited and thus it is possible for there to be more drivers that require a DMA channel than DMA channels available. In these cases, the function for setting up DMA MUST busy wait until a DMA channel is made available before returning. In general, when designing an application, it is important to be mindful of the number of DMA channels a device has and how many drivers need channels. If the number of device drivers that use 1 or more DMA channels is greater than the number of channels, then the application developer must be mindful of this and design around this constraint.</p>
<h2 id="ram-blocks">Ram blocks</h2>
<p>When the cpu access memory from ram, it will use the device's address and data bus to make the transfer occur. DMA is no different. If DMA attempts to access the same resource as the cpu, then either the cpu or the DMA controller will stall until the other device is finished.</p>
<p>A lot of devices will separate their memory into multiple ram blocks. The reason, with respect to DMA, is that having multiple ram blocks allow DMA to access one block of ram while the cpu works with ram in another ram block. If an application can design itself around this, it will help with the performance of the cpu and DMA when performing any sort of work.</p>
<p>For example, lets say you want to make an MP3 player project. Gaps in audio can cause audio distortions and artifacts like clicks and pops. Gaps can be prevented by always ensuring that audio is making its way to the DAC. To ensure that there is always audio available to be streamed through the DAC a double buffering approach is used, where one buffer is actively being streamed out to the DAC and the other buffer is being filled with the new audio data. A dedicated thread is provided for audio decoding and audio streaming. The audio stream thread takes a buffer of audio data, sets up DMA for the transfer and then blocks its own thread. The audio decoder can now fill the other buffer with decoded mp3 data. Now consider this, lets assume that the buffers are both on the same RAM chip. In this case, whenever the DMA and cpu attempt to access the ram block, one of them will be stalled waiting for the other to finish. This can reduce performance and potentially result in audio artifacts. If these buffers are located in different ram blocks, then the DMA can access the ram block without stalling the CPU and vise-versa.</p>
<p>Note that this also depends on if your system is a "Single Bus System" or a "Multi Bus System".</p>
<ul>
<li><strong>Single Bus System:</strong> If there is only one data and address bus shared by all components, then even with multiple RAM blocks, access to these blocks is serialized through the single bus. In this case, the DMA and CPU cannot truly operate in parallel when accessing different blocks, as the single bus must arbitrate between them. This can still lead to stalls, though the overall impact might be reduced if the arbiter is efficient.</li>
<li><strong>Multiple Bus System:</strong> Some more complex systems might employ multiple buses (e.g., a separate bus for DMA and CPU). This architecture can allow truly concurrent access to different RAM blocks, significantly reducing or eliminating stalls because each master has its own path to memory.</li>
</ul>
<h2 id="implementing-halplatformsetup_dma_transferdma">Implementing <code>hal::&lt;platform&gt;::setup_dma_transfer(dma)</code></h2>
<p>All parts of this section require the user manual for your particular device.</p>
<h3 id="implementing-the-dma-structure">Implementing the <code>dma</code> structure</h3>
<p>The <code>dma</code> structure should include fields for every possible configuration that the dma.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Channel selection should not be a field in the dam structure. The channel selected should be determined by the <code>setup_dma_transfer</code> call based on
which channels are available. Some dma devices provide a priority for each channel. The current philosophy is to ignore this priority system and simply provide the first channel that is available and if possible make the priority of all channels the same.</p>
</div>
<p>Here is an example dma structure from <code>libhal-lpc40</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">dma_transfer_type</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">uint8_t</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">/// Flow Control: DMA controller</span>
<span class="w">  </span><span class="n">memory_to_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b000</span><span class="p">,</span>
<span class="w">  </span><span class="c1">/// Flow Control: DMA controller</span>
<span class="w">  </span><span class="n">memory_to_peripheral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="p">,</span>
<span class="w">  </span><span class="c1">/// Flow Control: DMA controller</span>
<span class="w">  </span><span class="n">peripheral_to_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b010</span><span class="p">,</span>
<span class="w">  </span><span class="c1">/// Flow Control: DMA controller</span>
<span class="w">  </span><span class="n">peripheral_to_peripheral</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b011</span><span class="p">,</span>
<span class="w">  </span><span class="c1">/// Flow Control: Destination Peripheral</span>
<span class="w">  </span><span class="n">peripheral_to_peripheral_dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b100</span><span class="p">,</span>
<span class="w">  </span><span class="c1">/// Flow Control: Destination Peripheral</span>
<span class="w">  </span><span class="n">memory_to_peripheral_dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b101</span><span class="p">,</span>
<span class="w">  </span><span class="c1">/// Flow Control: Source Peripheral</span>
<span class="w">  </span><span class="n">peripheral_to_memory_sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b110</span><span class="p">,</span>
<span class="w">  </span><span class="c1">/// Flow Control: Source Peripheral</span>
<span class="w">  </span><span class="n">peripheral_to_peripheral_sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b111</span>
<span class="p">};</span>

<span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">dma_transfer_width</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">uint8_t</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">bit_8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b000</span><span class="p">,</span>
<span class="w">  </span><span class="n">bit_16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="p">,</span>
<span class="w">  </span><span class="n">bit_32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b010</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">dma</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">volatile</span><span class="o">*</span><span class="w"> </span><span class="n">source</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="k">volatile</span><span class="o">*</span><span class="w"> </span><span class="n">destination</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// With every transfer, increment the address of the source location. Set to</span>
<span class="w">  </span><span class="c1">// true to move forward through the length of the transaction. Set to false</span>
<span class="w">  </span><span class="c1">// to keep the address the same for the entire length of the transfer. Set</span>
<span class="w">  </span><span class="c1">// false is usually used when the address is a peripheral driver and the</span>
<span class="w">  </span><span class="c1">// register you are reading from updates. Set to true when you want to</span>
<span class="w">  </span><span class="c1">// transfer a sequence of data, an array, from ram to a peripheral or another</span>
<span class="w">  </span><span class="c1">// area of memory.</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">source_increment</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Same as source_increment but with the destination address.</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">destination_increment</span><span class="p">;</span>
<span class="w">  </span><span class="n">dma_transfer_width</span><span class="w"> </span><span class="n">source_transfer_width</span><span class="p">;</span>
<span class="w">  </span><span class="n">dma_transfer_width</span><span class="w"> </span><span class="n">destination_transfer_width</span><span class="p">;</span>
<span class="w">  </span><span class="n">dma_transfer_type</span><span class="w"> </span><span class="n">transfer_type</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>Removed from the example above are the source and destination request number fields which are specific to the <code>lpc40</code> series. The burst count is also not present as well. If you're devices has such fields and are required to work, then add them to your data structure. Reading the above code should give you an idea of what a user must do in order to establish a dma transfer.</p>
<p>Note the technique of using a strongly typed enumeration classes as binary control patterns. When making enumeration classes for each of your configuration parameters, it is wise to give the unique constants defined in the datasheet as the constants defined in the enum class. This way, the code for <code>setup_dma_transfer()</code> does not have to perform a translation from the value of the enum class to a value that the dma hardware can understand.</p>
<p>When implementing the structure do the following:</p>
<ol>
<li>Open datasheet and search for the "DMA" section. Generally there will be a short synopsis about the device and what it supports.</li>
<li>Read/skim the section on DMA. Locate the registers for controlling DMA and note what configurations it supports.</li>
<li>Copy the dma structure above.</li>
<li>Update the <code>dma_transfer_type</code> enum class fields with the set of values that match your device. If the enum class value codes cannot fit in std::uint8_t then the smallest size unsigned number that can fit your codes. If your device does not require or use such a construct, then simply delete the <code>dma_transfer_type</code> and <code>dma_transfer_type</code> field from the <code>dma</code> structure.</li>
<li>Update <code>dma_transfer_width</code> enum class with the binary codes for your device's DMA transfer width.</li>
<li>Add any other fields that are available for your dma besides channel selection.</li>
</ol>
<h3 id="implementing-the-setup_dma_transfer-function">Implementing the <code>setup_dma_transfer</code> function</h3>
<p>The dma code should look like the following. Read the comments to get an idea of what is necessary to make this work.</p>
<div class="highlight"><pre><span></span><code><span class="k">constexpr</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">dma_channel_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>

<span class="c1">// We need to provide memory to hold the callbacks for each dma channel. When</span>
<span class="c1">// the dma transfer is finished, an interrupt will be invoked. That interrupt</span>
<span class="c1">// handler will invoke the dma callback in this list.</span>
<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">callback</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">dma_channel_count</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dma_callbacks</span><span class="p">{</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">default_interrupt_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">handle_dma_interrupt</span><span class="p">()</span><span class="w"> </span><span class="k">noexcept</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">initialize_dma</span><span class="p">();</span>

<span class="c1">// Atomic flag for acquiring the dma</span>
<span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span><span class="w"> </span><span class="n">dma_busy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ATOMIC_FLAG_INIT</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup_dma_transfer</span><span class="p">(</span><span class="n">dma</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p_configuration</span><span class="p">,</span>
<span class="w">                        </span><span class="n">hal</span><span class="o">::</span><span class="n">callback</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p_interrupt_callback</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Step 1.</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// Compose the configuration, control, and whatever other registers you need</span>
<span class="w">  </span><span class="c1">// to setup the dma.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">config_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* ... */</span><span class="p">;</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">control_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* ... */</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Step 2.</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// Acquire atomic lock using spin lock</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">dma_busy</span><span class="p">.</span><span class="n">test_and_set</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">continue</span><span class="p">;</span><span class="w">  </span><span class="c1">// spin lock</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Step 3.</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// Initialize dma (this should be a one shot and should return early if the</span>
<span class="w">  </span><span class="c1">// dma has already been initialized).</span>
<span class="w">  </span><span class="c1">// Ensure that this call does not throw an exception, if so, use</span>
<span class="w">  </span><span class="n">initialize_dma</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Step 4.</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// Busy wait until a channel is available</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Step 5.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// Check for an available channel.</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">available_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* ... get available channel ... */</span>

<span class="w">    </span><span class="c1">// Lets assume that if the channel number is above 8 then all channels are</span>
<span class="w">    </span><span class="c1">// available.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">available_channel</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Step 6.</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// Copy callback to the callback array</span>
<span class="w">      </span><span class="n">dma_callbacks</span><span class="p">[</span><span class="n">available_channel</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_interrupt_callback</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Step 7.</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// Get &amp; setup dma channel</span>
<span class="w">      </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">dma_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_dma_channel_register</span><span class="p">(</span><span class="n">available_channel</span><span class="p">);</span>

<span class="w">      </span><span class="n">dma_channel</span><span class="o">-&gt;</span><span class="n">source_address</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_configuration</span><span class="p">.</span><span class="n">source</span><span class="p">);</span>
<span class="w">      </span><span class="n">dma_channel</span><span class="o">-&gt;</span><span class="n">destination_address</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p_configuration</span><span class="p">.</span><span class="n">destination</span><span class="p">);</span>
<span class="w">      </span><span class="n">dma_channel</span><span class="o">-&gt;</span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">control_value</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Step 8.</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// Start dma transfer</span>
<span class="w">      </span><span class="n">dma_channel</span><span class="o">-&gt;</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config_value</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Step 9. Release lock</span>
<span class="w">  </span><span class="n">dma_busy</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span><span class="w"> </span><span class="nf">initialize_dma</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// You can use the fact that the dma is powered on to determine if the device</span>
<span class="w">  </span><span class="c1">// has already been initialized.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_on</span><span class="p">(</span><span class="n">peripheral</span><span class="o">::</span><span class="n">gpdma</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Otherwise power it on</span>
<span class="w">  </span><span class="n">power_on</span><span class="p">(</span><span class="n">peripheral</span><span class="o">::</span><span class="n">gpdma</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Turn on interrupts</span>
<span class="w">  </span><span class="n">initialize_interrupts</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// enable the dma interrupt</span>
<span class="w">  </span><span class="n">hal</span><span class="o">::</span><span class="n">cortex_m</span><span class="o">::</span><span class="n">enable_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="o">::</span><span class="n">dma</span><span class="p">,</span><span class="w"> </span><span class="n">handle_dma_interrupt</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Replace this code with what enables the dma</span>
<span class="w">  </span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">handle_dma_interrupt</span><span class="p">()</span><span class="w"> </span><span class="k">noexcept</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// The zero count from the LSB tells you where the least significant 1 is</span>
<span class="w">  </span><span class="c1">// located. This allows the handled DMA interrupt callback to start at 0 and</span>
<span class="w">  </span><span class="c1">// end at the last bit.</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">countr_zero</span><span class="p">(</span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">interrupt_status</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">clear_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// NOTE: This may not be necessary on your device</span>
<span class="w">  </span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">interrupt_terminal_count_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clear_mask</span><span class="p">;</span>
<span class="w">  </span><span class="n">dma_reg</span><span class="o">-&gt;</span><span class="n">interrupt_error_clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clear_mask</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Call this channel&#39;s callback</span>
<span class="w">  </span><span class="n">dma_callbacks</span><span class="p">[</span><span class="n">status</span><span class="p">]();</span>
<span class="p">}</span>
</code></pre></div>
<p>Take the above code and update the code to fit the needs of your device.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../arm_cortex_m_bringup/" class="md-footer__link md-footer__link--prev" aria-label="Previous: üß† ARM Cortex M Bring Up">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                üß† ARM Cortex M Bring Up
              </div>
            </div>
          </a>
        
        
          
          <a href="../upgrade_to_libhal_3_device_library/" class="md-footer__link md-footer__link--next" aria-label="Next: ‚¨ÜÔ∏è Upgrade Device Library to 3.x.y">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                ‚¨ÜÔ∏è Upgrade Device Library to 3.x.y
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "content.tabs.link", "toc.integrate", "navigation.tracking", "navigation.footer"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>