
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../upgrade_to_libhal_3_device_library/">
      
      
        <link rel="next" href="../../project_information/status/">
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.47">
    
    
      
        <title>üèóÔ∏è Architectural Design Decisions - libhal</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architectural-design-decisions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
You're not viewing the latest version.
<a href="../../..">
  <strong>Click here to go to latest.</strong>
</a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="libhal" class="md-header__button md-logo" aria-label="libhal" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            libhal
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              üèóÔ∏è Architectural Design Decisions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/libhal/libhal/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    libhal
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  üè° Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../getting_started/" class="md-tabs__link">
        
  
    
  
  üöÄ Getting Started

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../user_guide/setup_vscode/" class="md-tabs__link">
          
  
  üìñ User Guide

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../education/embedded_systems/" class="md-tabs__link">
          
  
  üè´ Education

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../philosophy/" class="md-tabs__link">
          
  
  üìö Contributor Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../project_information/status/" class="md-tabs__link">
          
  
  üìä Project Information

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../api/" class="md-tabs__link">
        
  
    
  
  üß© APIs

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="libhal" class="md-nav__button md-logo" aria-label="libhal" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    libhal
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/libhal/libhal/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    libhal
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üè° Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üöÄ Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    üìñ User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            üìñ User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/setup_vscode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üßëüèø‚Äçüíª Setting up VSCode
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/fundamentals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üß± Fundamentals of libhal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üîó Interfaces in libhal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/debugging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üéØ Debugging Firmware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/error_handling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ü™§ Error Handling in libhal
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/policy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ‚öñÔ∏è Policies & FAQ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    üè´ Education
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            üè´ Education
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/embedded_systems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What are Embedded Systems?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/bitmasking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bit Masking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microcontroller Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/gpio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General Purpose I/O
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/dma/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DMA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/timers_and_counters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Timers & Counters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/adc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/pwm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PWM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/spi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SPI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/uart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UART
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/i2c/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    I2C
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/dac/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DAC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/canbus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CAN BUS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/sensors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basics of Sensors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/actuators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basics of Actuators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/rtos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RTOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../education/tbd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TBD
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    üìö Contributor Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            üìö Contributor Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../philosophy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üìú Design Philosophy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../organization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üóÉÔ∏è Organization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../style/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üé® Style Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interface_design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üîó Interface Design Philosophy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../library_guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üîπ Library Development Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../arm_cortex_m_bringup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üß† ARM Cortex M Bring Up
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dma_tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ‚è© DMA Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade_to_libhal_3_device_library/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ‚¨ÜÔ∏è Upgrade Device Library to 3.x.y
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    üèóÔ∏è Architectural Design Decisions
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    üèóÔ∏è Architectural Design Decisions
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a1-always-use-modern-c" class="md-nav__link">
    <span class="md-ellipsis">
      A.1 Always use modern C++
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a2-interface-design-choices" class="md-nav__link">
    <span class="md-ellipsis">
      A.2 Interface Design Choices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="A.2 Interface Design Choices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a21-no-utility-methods-in-interfaces-ufcs" class="md-nav__link">
    <span class="md-ellipsis">
      A.2.1 No utility methods in interfaces (UFCS)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a3-using-tweak-files-over-macros" class="md-nav__link">
    <span class="md-ellipsis">
      A.3 Using tweak files over macros
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a4-header-only-implementations-see-amendment-a21" class="md-nav__link">
    <span class="md-ellipsis">
      A.4 ‚ùå ~~Header Only Implementations~~ ‚û°Ô∏è (See Amendment A.21)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a5-encapsulated-memory-mapped-classes" class="md-nav__link">
    <span class="md-ellipsis">
      A.5 Encapsulated Memory Mapped Classes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a6-using-halfunction_ref-over-stdfunction" class="md-nav__link">
    <span class="md-ellipsis">
      A.6 Using hal::function_ref over std::function&amp;
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a7-using-virtual-runtime-polymorphism" class="md-nav__link">
    <span class="md-ellipsis">
      A.7 Using virtual (runtime) polymorphism
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a8-strongly-leverage-package-managers" class="md-nav__link">
    <span class="md-ellipsis">
      A.8 Strongly Leverage Package Managers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a9-foundation-interface-stability" class="md-nav__link">
    <span class="md-ellipsis">
      A.9 Foundation &amp; Interface Stability
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a10-libhal-driver-directory" class="md-nav__link">
    <span class="md-ellipsis">
      A.10 libhal driver directory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a11-github-actions-remote-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      A.11 Github Actions &amp; Remote Workflows
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a12-boostut-as-our-unit-testing-framework" class="md-nav__link">
    <span class="md-ellipsis">
      A.12 Boost.UT as our unit testing framework
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a13-boostleaf-for-error-handling-see-amendment-a22" class="md-nav__link">
    <span class="md-ellipsis">
      A.13 ‚ùå ~~Boost.LEAF for error handling~~ ‚û°Ô∏è (See Amendment A.22)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a14-using-statement-expressions-with-hal_check-see-amendment-a22" class="md-nav__link">
    <span class="md-ellipsis">
      A.14 ~~Using Statement Expressions with HAL_CHECK()~~ ‚û°Ô∏è (See Amendment A.22)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a15-libhal-will-not-use-fixed-point" class="md-nav__link">
    <span class="md-ellipsis">
      A.15 libhal WILL NOT use fixed point
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a16-libhal-does-not-use-a-units-library" class="md-nav__link">
    <span class="md-ellipsis">
      A.16 libhal does NOT use a units library
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a17-always-return-halresultt-from-every-api-see-amendment-a22" class="md-nav__link">
    <span class="md-ellipsis">
      A.17 ~~Always return hal::result&lt;T&gt; from every API~~ ‚û°Ô∏è (See Amendment A.22)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a18-using-inplace_functionhalcallback-for-interrupt-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      A.18 Using inplace_function/hal::callback for interrupt callbacks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a19-halcallback-sizing" class="md-nav__link">
    <span class="md-ellipsis">
      A.19 hal::callback sizing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a20-why-functions-that-setup-events-do-not-return-halstatus-see-amendment-a22" class="md-nav__link">
    <span class="md-ellipsis">
      A.20 ~~Why functions that setup events do not return hal::status~~ ‚û°Ô∏è (See Amendment A.22)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a21-critical-importance-of-providing-prebuilt-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      A.21 Critical importance of providing prebuilt binaries
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a22-use-c-exception-for-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      A.22 Use C++ Exception for Error handling
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    üìä Project Information
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            üìä Project Information
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_information/status/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üü¢ Library Status üî¥
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../project_information/about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    üß© APIs
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="architectural-design-decisions">üèóÔ∏è Architectural Design Decisions</h1>
<h2 id="a1-always-use-modern-c">A.1 Always use modern C++</h2>
<p>libhal uses the modern C++. Meaning that libhal is will follow the most modern
and available compilers available. When a sufficient number of features have
become available in both GCC &amp; Clang and are determined to be useful to libhal
libhal will increment its major number to indicate that it has upgraded compiler
versions.</p>
<p>This decision exists to escape the issues of vendor and toolchain lock in thats
prevalant in the C++ and embedded industry. With sufficient testing, upgrading
compilers shouldn't result in bugs in applications.</p>
<h2 id="a2-interface-design-choices">A.2 Interface Design Choices</h2>
<p>Interfaces MUST follow this layout:</p>
<ul>
<li>Use <code>#pragma once</code> at the start of the file: Simpler than an include guard</li>
<li>All <code>virtual</code> functions must be private &amp; each <code>virtual</code> functions is
  accompanied by a public API that is used to call the virtual API</li>
<li>~~The return type of each API MUST be a <code>result&lt;T&gt;</code> where <code>T</code> is a structure.~~ Amendment 1.0: Return types should never be a structure with the
  expectation that it can be grown in the future. This is an ABI break.</li>
</ul>
<p>Pragma once is needed to ensure files are included once. Its less error prone
then hand writing include guards.</p>
<p>The reasons for a private virtual with public API can be found in this
article (TODO: add link to article).</p>
<p>Returning a structure for each API means that, in the future, if the return type
needs to be extended, it can be done without breaking down stream libraries. For
example:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">adc</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">read_t</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// V1</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">percentage</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">read_t</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// V2</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">percentage</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Optional field that is default initialized to std::nullopt indicating</span>
<span class="w">    </span><span class="c1">// that it defaults to not exist</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bit_resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>Given that the field <code>bit_resolution</code> is an optional, code looking for it can
determine if it is available or not, and code that never used it can ignore it.</p>
<h3 id="a21-no-utility-methods-in-interfaces-ufcs">A.2.1 No utility methods in interfaces (UFCS)</h3>
<p>Utility functions shall not exist in interface definitions. For example,
<code>hal::i2c</code> could have a <code>hal::i2c::write()</code> and <code>hal::i2c::read()</code> function
implemented in its interface.</p>
<p>This has the effect of reducing the number of headers in the interface files and
dependencies. This, in turn, results in an interface that is minimal, clean, and
simple.</p>
<p>The major purpose of this is to keep compile times down as much possible for
each interface. This also ensures that the "pay-for-what-you-use" model is
followed. No need to pay for a utility you never planned to use.</p>
<p>The final reason is in preparation for UFCS (Unified Function Call Syntax). UFCS
is a proposal for C++23 and C++26. It did not get into C++23 but is slated for
review in 26. For more details see this page <a href="https://brevzin.github.io/c++/2019/04/13/ufcs-history/">What is unified function call
syntax anyway?</a>.</p>
<h2 id="a3-using-tweak-files-over-macros">A.3 Using tweak files over macros</h2>
<p>Tweak files were used as an alternative to MACROS. MACROs can be quite
problematic in many situations and are advised against in the core C++
guidelines. The benefits of tweak files can be found
<a href="https://vector-of-bool.github.io/2020/10/04/lib-configuration.html">here</a>.</p>
<h2 id="a4-header-only-implementations-see-amendment-a21">A.4 ‚ùå ~~Header Only Implementations~~ ‚û°Ô∏è (See Amendment A.21)</h2>
<p>libhal libraries and drivers are, in general, header-only. libhal uses header
only implementations in order to enable the broadest set of package managers,
build system and projects to use it.</p>
<p>The strongest reason for a header-only approach is due to the fact that libhal
libraries never intend to be distributed in prebuilt binaries. Conan is designed
to ship with prebuilt binaries or build against the host machine. These settings
can be altered, but you still end up with a single global prebuilt binary for a
driver does not make sense when that driver could be used in a variety of
environments such as the host device for host side tests, a specific target
device, and a target device that is in the family of that specific target
device.</p>
<p>For example, lets consider liblpc40xx. If you are building to target the lpc4078
chip then that prebuilt ought to be built with usage of FPU registers enabled.
But if you use that same prebuilt with the lpc4074, you'll find that the program
crashes because the 74 variant does not have an FPU. You can attempt make a
prebuilt binary for ever possible build variation that an embedded engineer may
want, but you'll always come up short. The better approach is to simply build
the library each time, thus ensuring that the build flags are considered each
time.</p>
<p>If compile-times are a concern, there are reasonably easy methods for managing
this. See <a href="#">Handling Long Compile Times</a>.</p>
<h2 id="a5-encapsulated-memory-mapped-classes">A.5 Encapsulated Memory Mapped Classes</h2>
<p>Target drivers that use Memory-Mapped-IO usually come with a vendor generated
header file that describes each peripheral as a structure type, along with bit
mask MACROs, and MACROs that result in pointers to each peripheral in memory.
The main problem using these headers files causes is naming conflicts. Many of
these vendor generated headers work with both C and C++. Meaning that namespaces
are not utilized. And many do not expect that they will be used in an
environment where another vendor generated header file will exists. So no care
is taken to ensure that the names of the types are unique. This WILL cause
linker errors as the linker sees both <code>GPIO_TypeDef</code> from an STM library and
<code>GPIO_TypeDef</code> from an LPC library that aren't the same.</p>
<p>Because of this we have style <a href="">S.x Encapsulated Memory Mapped classes</a>
guideline.</p>
<h2 id="a6-using-halfunction_ref-over-stdfunction">A.6 Using <code>hal::function_ref</code> over <code>std::function&amp;</code></h2>
<p><code>std::function</code> has all of the flexibility and functionality needed, but it has
the potential to allocate and requires potentially expensive copy operations
when passed by value.</p>
<p><code>hal::function_ref</code> is a non-owning version of the <code>std::function</code>, with a size
of just two pointers. <code>hal::function_ref</code> fits most use cases in that class
functions that take them only need them for the duration of the function and do
not need to own them for later.</p>
<p>!!! info <code>hal::function_ref</code> is an alias for <code>tl:function_ref</code> which comes from
    the project
    <a href="https://github.com/TartanLlama/function_ref">TartanLlama/function_ref</a>.</p>
<h2 id="a7-using-virtual-runtime-polymorphism">A.7 Using <code>virtual</code> (runtime) polymorphism</h2>
<p>Polymorphism is critical for libhal to reach the goals of flexible and easy of
use. Static based polymorphism, by its nature, is inflexible at runtime and can
be quite complicated to work with.</p>
<p>Runtime polymorphism, or the usage of <code>virtual</code> enables a broader scope of
flexibility and isolation between drivers and application logic. The only
downside to using <code>virtual</code> polymorphism is the cost of a virtual function call.
But the actual cost of making a virtual function call is usually tiny in
comparison to the work performed in the actual API call. In most cases the call
latency and lack of inlining of a virtual call isn't an important factor in most
applications.</p>
<p>And over all, along with the broad amount of flexibility comes the ease of use.
Virtual polymorphism for interfaces is very easy to perform and has a ton of
language support.</p>
<h2 id="a8-strongly-leverage-package-managers">A.8 Strongly Leverage Package Managers</h2>
<p>Finding and integration libraries into C++ programs is a pain. Doing the same
thing for embedded is doubly so, especially if there is vendor IDE lock in.
libhal seeks to escape this by using the available package managers and indexes.</p>
<p>Libhal was designed around and split up into parts that each come together via
these package managers. The purpose of this design is to achieve:</p>
<ul>
<li>Stable version and release control for each library</li>
<li>Can be easily found the indexes</li>
<li>Ease of integration</li>
</ul>
<h2 id="a9-foundation-interface-stability">A.9 Foundation &amp; Interface Stability</h2>
<p><code>libhal-util</code>, <code>libhal-mock</code> and <code>libhal-soft</code> were all apart of <code>libhal</code>
originally, but due to the constant changes and API breaks in those categories
of code, the version number of <code>libhal</code> would increment constantly, shifting the
foundation of the ecosystem. To prevent constant churn and API breaks <code>libhal</code>
was split into those 4 libraries.</p>
<p>The goal is to keep the version number for <code>libhal</code> constant for long periods of
time to prevent breaking down stream libraries, drivers, and applications.</p>
<h2 id="a10-libhal-driver-directory">A.10 libhal driver directory</h2>
<p>One of the libhal repos will contain a directory of libhal libraries that extend
it along with which interfaces it implements and what type of library it is.</p>
<p>Official libhal libraries must go into the directory. Developers outside of the
libhal organization can also contribute to and opt into this directory by making
a PR to the repo containing the directory.</p>
<p>The purpose of this is to make finding and exploring the available set of
drivers easier for the end developer by having them all in one place.</p>
<h2 id="a11-github-actions-remote-workflows">A.11 Github Actions &amp; Remote Workflows</h2>
<p>libhal uses github and github action "workflow_dispatch" to allow other repos to
reuse libhal's continuous integration steps. The actions are configurable via
input parameters to allow libraries to customize and control how the CI works.</p>
<p>libhal's CI attempts to use as many tools as reasonable to make sure that the
C++ source code follows the style guide, C++ core guidelines and retains a
certain level of quality. All offical libhal libaries must opt in to the common
libhal/libhal workflow.</p>
<p>This helps to ensure that all projects are held to the same standard and
quality. The workflow files can be found in <code>libhal/libhal/.github/workflows</code>.</p>
<h2 id="a12-boostut-as-our-unit-testing-framework">A.12 Boost.UT as our unit testing framework</h2>
<p>Boost.UT was chosen for its lack of macros, stunning compile time performance,
and its ease of use.</p>
<h2 id="a13-boostleaf-for-error-handling-see-amendment-a22">A.13 ‚ùå ~~Boost.LEAF for error handling~~ ‚û°Ô∏è (See Amendment A.22)</h2>
<p>One major issue with any project is handling errors. Because the <code>libhal</code>
interfaces can be used in such broad environments, it is hard to determine what
the BEST error type in advance could work for all users. Some use error codes,
some use <code>std::expected&lt;T, E&gt;</code>, and some use exceptions.</p>
<p>Error codes are problematic as they tend to lack details and context around an
error. Sometimes the documentation along with the error code provides all of the
necessary context, but many times more context is needed.</p>
<p><code>std::expected&lt;T, E&gt;</code> seems like a better alternative to error codes, but... is
it really? What should <code>E</code> be? An error code? What if we have it be an error
code and a const string. What if we want a file name and function name? What
about a line number? What about 16 bytes for holding context information about
the error? That should be enough, right? What about- what about- what about? ...
wait, how big is this error type? 32 bytes? Wasn't this supposed to be light
weight? Unfortunately, <code>std::expected</code> is not a good choice for interfaces with
extremely broad and unknowable of error states. This forces the error type to be
massive to accommodate everything and everyone.</p>
<p>Exceptions somewhat fix this issue but are still lacking. The benefit of
exceptions is that you can throw just about anything, meaning the developer can
provide loads of information in the thrown object. But exceptions fail on 4
counts:</p>
<ul>
<li>Exceptions tend to not be available for embedded systems, either due to a
    toolchain not compiling with them enabled or because a project has strict
    requirements that forbid exceptions.</li>
<li>When exceptions do occur, the amount of time it takes to reach its catch can
    take a long time, longer than what real time applications can handle.</li>
<li>Normally requires heap allocation</li>
<li>Exceptions can only throw one type and the cost of those thrown exceptions
    are always paid for.</li>
</ul>
<p>Boost.LEAF has the following properties:</p>
<ul>
<li>Portable single-header format, no dependencies.</li>
<li>Tiny code size when configured for embedded development.</li>
<li>No dynamic memory allocations, even with very large payloads.</li>
<li>Deterministic unbiased efficiency on the "happy" path and the "sad" path.</li>
<li>Error objects are handled in constant time, independent of call stack depth.</li>
<li>Can be used with or without exception handling.</li>
<li>Can throw more than 1 error at a time</li>
</ul>
<p>All of these features are critical for libhal to have the performance for real
time applications.</p>
<p>The last feature is important for debugging, bug reports, and context specific
error handling. Boost.LEAF gives the driver the choice to emit several error
types and allows the user to pick out which one they would like to opt to catch
if any of them. This can be used to capture an error code as well as s snapshot
of the register map of a peripheral, the object's current state or even a debug
message.</p>
<h2 id="a14-using-statement-expressions-with-hal_check-see-amendment-a22">A.14 ~~Using Statement Expressions with <code>HAL_CHECK()</code>~~ ‚û°Ô∏è (See Amendment A.22)</h2>
<p><code>HAL_CHECK()</code> is the only MACRO in <code>libhal</code>. It exists because there is nothing
like Rust's <code>?</code> operator which either unwraps a value or returns an error from
the current function. The "Statement Expression" only works with GCC &amp; Clang
which is one of the reasons why <code>libhal</code> only supports those compilers. Compare
the following two expressions:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 1. Using statement expressions</span>
<span class="k">auto</span><span class="w"> </span><span class="n">percentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_CHECK</span><span class="p">(</span><span class="n">adc</span><span class="p">.</span><span class="n">read</span><span class="p">()).</span><span class="n">percentage</span><span class="p">;</span>

<span class="c1">// 2. Without using statement expressions</span>
<span class="n">HAL_CHECK</span><span class="p">(</span><span class="n">adc_read_temporary</span><span class="p">,</span><span class="w"> </span><span class="n">adc</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
<span class="k">auto</span><span class="w"> </span><span class="n">percentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adc_read_temporary</span><span class="p">.</span><span class="n">percentage</span><span class="p">;</span>
</code></pre></div>
<p>The second option looks very unnatural and require explanation. On the other
hand users who have never seen <code>HAL_CHECK()</code> in action have an immediate idea of
how it works in the first section of the code. Portability to other compilers
was sacrificed in order to make the code easier to read, understand, and write.</p>
<h2 id="a15-libhal-will-not-use-fixed-point">A.15 <code>libhal</code> WILL NOT use fixed point</h2>
<p>Because fixed point will NOT result in better performance or space savings
compared to SOFTWARE floating point. Team did venture to use fixed point
throughout the entire code base and when we felt that the fixed point code
reached a point where it was usable everywhere, we benchmarked it and got these:</p>
<div class="highlight"><pre><span></span><code>double_time            = 8921794
[i64 +Round]fixed_time = 4558238 (best fixed point option)
[soft]float_time       = 1424913
[i64 -Round]fixed_time = 1410720 (precision issues)
[i32 +Round]fixed_time = 815107  (will easily overflow)
[hard]float_time       = 110089  (not always available)
[i32 -Round]fixed_time = 95085   (will not actually work)
</code></pre></div>
<p>Here is an old gist of the example:
<a href="https://gist.github.com/kammce/920166314b8b49924f906bd8d26f2450">kammce/fixed_v_float.cpp</a></p>
<p>The above metrics were for a program that run a map function to map an input
number from one range to another range. The numbers on the right hand side are
the number of cycles of a Arm Cortex M4F DWT counter. Fixed point 32-bit
integers is enough for a representation but to handle arithmetic like
multiplication, 64-bit integers were needed. Those 64-bit operations resulted in
computation time approaching double floating point. If a system used 32-bit
floats, the 32-bit fixed point would be ~4x slower. If a system used double
floating point in software mode, it will only be ~2x slower than 32-bit fixed
point. Fixed point, over all, is more expensive in terms of space and time.</p>
<p>If you don't believe the metrics measured here, you can also check <a href="https://github.com/MikeLankamp/fpm/blob/master/docs/performance.md">fpm
performance
metrics</a>.
Notice how fpm fairs far worse for anything that isn't addition/subtraction.</p>
<p>See these articles for more details:</p>
<ul>
<li><a href="https://accu.org/journals/overload/18/99/harris_1702/">You're Going To Have To
  Think!</a></li>
<li><a href="https://accu.org/journals/overload/18/100/harris_1717/">WHY FIXED POINT WON'T CURE YOUR FLOATING POINT
  BLUES</a></li>
<li><a href="https://accu.org/journals/overload/19/101/harris_1986/">WHY RATIONALS WON‚ÄôT CURE YOUR FLOATING POINT
  BLUES</a></li>
<li><a href="https://accu.org/journals/overload/19/102/harris_1979/">Why Computer Algebra Won‚Äôt Cure Your Floating Point
  Blues</a></li>
<li><a href="https://accu.org/journals/overload/19/103/harris_1974/">Why Interval Arithmetic Won‚Äôt Cure Your Floating Point
  Blues</a></li>
</ul>
<h2 id="a16-libhal-does-not-use-a-units-library">A.16 <code>libhal</code> does NOT use a units library</h2>
<p>Unit libraries have the potential to really help prevent an entire category of
unit based errors, it is also extremely difficult and annoying to use.</p>
<p>Th article <a href="https://onlinelibrary.wiley.com/doi/10.1002/spe.2926">Unit of measurement libraries, their popularity and
suitability</a> goes into
detail about the usability issues faced by unit libraries. Because, at the time
of writing <code>libhal</code> there is not a unit library that is easy to use and concise,
<code>libhal</code> decided to simply stick with 32-bit floats and helper UDLs.</p>
<h2 id="a17-always-return-halresultt-from-every-api-see-amendment-a22">A.17 ~~Always return <code>hal::result&lt;T&gt;</code> from every API~~ ‚û°Ô∏è (See Amendment A.22)</h2>
<p>Every interface in libhal returns a <code>hal::result&lt;T&gt;</code> type.</p>
<p>The return types should be a <code>result&lt;T&gt;</code> because the implementation could be
an abstraction for anything. As an example, it could come from an I2C to PWM
generator and if something goes wrong with the i2c communication, the
information must be emitted from the function.</p>
<h2 id="a18-using-inplace_functionhalcallback-for-interrupt-callbacks">A.18 Using <code>inplace_function</code>/<code>hal::callback</code> for interrupt callbacks</h2>
<p>There are interfaces such as <code>hal::can</code>, <code>hal::interrupt_pin</code>, and
<code>hal::timer</code> that all have APIs for setting a callback.</p>
<p>Because those callbacks could be lambdas, function objects, pure functions, or
other callable types, we need a polymorphic type erased function type that can
take any callable type as input and call it when its <code>operator()</code> is called.</p>
<p>The options for these callbacks are:</p>
<ul>
<li><code>std::function</code><ul>
<li>PROS<ul>
<li>Part of the standard library</li>
<li>Can take any callable type without restrictions</li>
</ul>
</li>
<li>CONS<ul>
<li>Allocating (compiler implementations will use SBO but the size of
  those buffers are not specified in the standard and should not be
  relied upon)</li>
<li>Can be quite large in size (40 bytes on 32-bit arm)</li>
</ul>
</li>
</ul>
</li>
<li><code>function_ref</code><ul>
<li>PROS<ul>
<li>Very lightweight (very fast construction)</li>
<li>Very small size (2 pointers in size)</li>
</ul>
</li>
<li>CONS<ul>
<li>For this to work as a callback, the callable passed to the
  <code>function_ref</code> must have a lifetime that is greater than the object
  implementing the interface.</li>
</ul>
</li>
</ul>
</li>
<li><code>inplace_function</code><ul>
<li>PROS<ul>
<li>Works and behaves just like <code>std::function</code></li>
</ul>
</li>
<li>CONS<ul>
<li>Fixed callable size limit</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>std::function</code> is automatically out because it is allocating. Using
<code>std::function</code> for any interface API would ensure that applications that
disallow dynamic allocations after boot or in general could never use them.</p>
<p><code>function_ref</code> has two great PROS but the largets CON is lifetime issues that
are really easy to fall into. Specifically something like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">obj</span><span class="p">.</span><span class="n">on_event</span><span class="p">([</span><span class="o">&amp;</span><span class="n">single_capture</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// does a thing  ...</span>
<span class="p">});</span>
</code></pre></div>
<p>The lambda is actually a temporary! So after this call it is out of scope and
no longer exists. If the reference to temporary is stored and called later,
the code WILL suffer from a "stack use after scope" violation which is
undefined behavior.</p>
<p><code>inplace_function</code> has all of the features of <code>std::function</code> but with limited
size. Due to this, constructing an <code>inplace_function</code> is deterministic and
relatively light weight.</p>
<h2 id="a19-halcallback-sizing">A.19 <code>hal::callback</code> sizing</h2>
<p><code>hal::callback</code> is an alias to <code>inplace_function</code> with a buffer size of 2
pointers (<code>sizeof(std::intptr_t) * 2</code>). This size was chosen in order to be
small and easily storable. Two pointers worth of size should be enough to hold
a pointer to <code>this</code> in classes as well a pointer to some sort of state object.</p>
<p>The size of the callback object was not choosen in order to improve the
performance of calling callback setting class functions. Even with the small
size of <code>hal::callback</code>, its too large to take advantage of register based
parameter passing. Thus the size of 2 pointers was mostly to help in keeping
the memory footprint of the <code>callback</code> small. In most cases, setting an
callback is something that is either done once or done very infrequently, and
thus does not get much of a benefit from higher performance function calls.</p>
<h2 id="a20-why-functions-that-setup-events-do-not-return-halstatus-see-amendment-a22">A.20 ~~Why functions that setup events do not return <code>hal::status</code>~~  ‚û°Ô∏è (See Amendment A.22)</h2>
<p>Functions like <code>hal::can::on_receive()</code> and <code>hal::interrupt_pin::on_trigger()</code>
return void and not <code>hal::status</code> like other APIs. Thus these functions cannot
return an error and are considered "infallible". There infallibility
guarantee makes constructing drivers using these interfaces easier. It also
eliminates the need for drivers to concern themselves with handling errors from
these APIs.</p>
<p>This guarantee is easily made, because having any one of these APIs fail IS A
bug and not something that a developer should or could be responsible with
handling. These APIs MUST be implemented as target library peripheral drivers
because setting interrupts is something that only target and processor libraries
can do. Setting up and configuring interrupts is only possible if the processor
supports it. Being apart of a target library means that they know exactly
the set of possible configurations that are allowed. This also means that
constructing a target peripheral with interrupt customization can be include
compile time checks as well.</p>
<h2 id="a21-critical-importance-of-providing-prebuilt-binaries">A.21 Critical importance of providing prebuilt binaries</h2>
<p>This amends architectural component A.4 and pivots away from header only
libraries over to prebuilt binaries.</p>
<p>The following are the reasons why supporting, producing and distibuting prebuilt
binaries is critical to libhal.</p>
<ul>
<li>‚è±Ô∏è <strong>Faster compilation times</strong>: When a project grows in size, compiling
  a C++ codebase can become time-consuming. By using precompiled binaries,
  the compiler has less work to do because portions of the code have already
  been compiled. It doesn't need to parse and compile the same headers over and
  over again. Developers will refuse to use libhal if it results in extremely
  long compilation times. They will tire of the project and seek faster to
  compile alternatives.</li>
<li>‚úÖ <strong>Consistency</strong>: With precompiled binaries, you can be sure that the same
  code will be compiled in the same way, which can reduce inconsistencies
  between different environments or build configurations. libhal will not be
  taken seriously if libhal didn't use prebuilt binaries and also support
  producing them. Distributing consistent code in a consistent form will be a
  requirement for many organizations seeking to use libhal.</li>
<li>üì¶ <strong>Code distribution and updates</strong>: When distributing C++ code, rather than
  give out the full source code or require users to compile it themselves,
  providing a precompiled binary is more user-friendly. Updates to the program
  can also be handled by replacing the old binaries with the new ones, without
  requiring the end-user to handle the compilation process. The philosophy of
  conan regarding library packages is that, at their core, C++ libraries are
  header files and prebuilt binaries.</li>
<li>üîí <strong>Protection of Intellectual Property</strong>: Precompiled binaries are much
  harder to reverse-engineer than raw source code. If a developer wants to
  write an application and distribute the binary, but the C++ code contains
  proprietary algorithms or trade secrets that you don't want to expose to the
  public, distributing it as a precompiled binary can provide an additional
  layer of protection.</li>
</ul>
<p>In order to provide the best experience for our developers as well as necessary
features of the platform, libhal emphasizes prebuilt libraries over header only.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Why the sudden change from A.4 to this? Supporting header-only made bringing
up libhal much easier. The process of implementing prebuilt binaries
required adding additional architecture settings, required the use of
conan profiles to make the arm-gnu-toolchain available globally for all
packages, figuring out how to insert architectural compiler flags and ensure
they propogate to all packages took time and was a complex process. And
header-only libraries allowed the initial version of libhal to bypass all
of this.</p>
</div>
<h2 id="a22-use-c-exception-for-error-handling">A.22 Use C++ Exception for Error handling</h2>
<p>libhal uses C++ exceptions for these reasons:</p>
<ol>
<li>Removes runtime cost of calling functions that error codes, result types,
   and sentinel variables.</li>
<li>Reduces code size greatly by:</li>
<li>Amortizing the error handling mechanism to a single set of functions
      rather than distributing the workload across all functions that can error.</li>
<li>Unwind information is a compressed ISA that only needs 8 bits per
      instruction in ARM (32 and 64), where as normal ARM or Thumb-2 which require 16 to 32 bits of information, resulting in code bloat.</li>
<li>GCC's Language Specific Data Area (LSDA) is a further compressed data
      structure for determining if a frame contains a suitable catch block or cleanup routine.</li>
</ol>
<p>Issues regarding memory allocations can be overcome by simply overriding/
wrapping <code>__cxa_allocate_exception</code> and using a statically allocated buffer.In
the case of multiple threads, each thread can be given its own memory buffer
through TLS or a circular pool of blocks with an <code>std::atomic&lt;int&gt;</code> for every
thread to use.</p>
<p>Exception throw runtime can be reduced by optimizing <code>__cxa_throw</code>'s
implementation.</p>
<p>The runtime is determinist because the grand majority of our code is statically
linked. This means our code is not concerned with shared library locking the
exception table down with a mutex to update it. This mutex lock will blocking
threads from continuing to unwind, making the time non-determinist. Once you
remove that, your unwind time is deterministic.</p>
<p>The issue with massive code bloat when you enable <code>-fexceptions</code> only comes
from the linux version of <code>std::terminate</code> which uses <code>&lt;iostream&gt;</code> and some
other locale related stuff. Simply overriding this with your own implmentation
fixes this issue and reduces code size by ~100kB.</p>
<p>A link to a paper written by Khalil Estell will be linked here to describe in
detail why C++ exception handling is the superior error handling mechanism for
embedded systems and software in general when performance and code size are
critical concerns.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../upgrade_to_libhal_3_device_library/" class="md-footer__link md-footer__link--prev" aria-label="Previous: ‚¨ÜÔ∏è Upgrade Device Library to 3.x.y">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                ‚¨ÜÔ∏è Upgrade Device Library to 3.x.y
              </div>
            </div>
          </a>
        
        
          
          <a href="../../project_information/status/" class="md-footer__link md-footer__link--next" aria-label="Next: üü¢ Library Status üî¥">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                üü¢ Library Status üî¥
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "content.tabs.link", "toc.integrate", "navigation.tracking", "navigation.footer"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>